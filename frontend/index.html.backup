<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary SEO -->
    <title>ZNodes - Zcash Network Node Monitor | Live Zcashd & Zebra Nodes</title>
    <meta name="description" content="Real-time Zcash network monitor. Track live zcashd and Zebra nodes, view network statistics, block height, and node distribution. Monitor the Zcash P2P network.">
    <meta name="keywords" content="Zcash, ZNodes, zcashd, Zebra, Zcash nodes, cryptocurrency nodes, Zcash network, blockchain nodes, Zcash monitor, ZEC nodes, Zcash P2P, network explorer, node tracker, Zcash mainnet">
    <meta name="author" content="ZNodes">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <link rel="canonical" href="https://znodes.live/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://znodes.live/">
    <meta property="og:title" content="ZNodes - Live Zcash Network Monitor">
    <meta property="og:description" content="Real-time monitoring of Zcash network nodes. Track zcashd and Zebra nodes, network health, and blockchain statistics.">
    <meta property="og:image" content="https://znodes.live/zcash-logo.png">
    <meta property="og:site_name" content="ZNodes">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://znodes.live/">
    <meta name="twitter:title" content="ZNodes - Live Zcash Network Monitor">
    <meta name="twitter:description" content="Real-time monitoring of Zcash network nodes. Track zcashd and Zebra nodes live.">
    <meta name="twitter:image" content="https://znodes.live/zcash-logo.png">
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#f4b728">
    <meta name="application-name" content="ZNodes">
    <meta name="apple-mobile-web-app-title" content="ZNodes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/zcash-logo.png">
    <link rel="apple-touch-icon" href="/zcash-logo.png">
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ZNodes",
        "description": "Real-time Zcash network node monitor tracking zcashd and Zebra nodes",
        "url": "https://znodes.live",
        "applicationCategory": "Cryptocurrency",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "ZNodes"
        },
        "about": {
            "@type": "Thing",
            "name": "Zcash",
            "description": "Zcash cryptocurrency network"
        },
        "keywords": "Zcash, zcashd, Zebra, cryptocurrency, blockchain, nodes, network monitor"
    }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #0f0f11;
            --bg-card: #141416;
            --border: #1f1f23;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --accent: #f4b728;
            --accent-dim: rgba(244, 183, 40, 0.1);
            --green: #22c55e;
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container { 
            max-width: 1280px; 
            margin: 0 auto; 
            padding: 0 24px; 
        }
        
        /* Navigation */
        nav { 
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }
        
        .nav-content { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .logo { 
            width: 28px; 
            height: 28px; 
        }
        
        .brand, h1.brand { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        
        .brand span {
            color: var(--accent);
        }
        
        .live-badge { 
            background: var(--green);
            color: #fff; 
            padding: 3px 10px; 
            border-radius: 100px; 
            font-size: 11px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: auto;
        }
        
        .uptime-chip {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .uptime-chip span {
            color: var(--text-primary);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        /* Main Content */
        main {
            padding: 32px 0;
        }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 16px; 
            margin-bottom: 24px;
        }
        
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        .stat-card { 
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px; 
            padding: 20px;
        }
        
        .stat-label { 
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value { 
            font-size: 28px; 
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }
        
        .stat-value.accent {
            color: var(--accent);
        }
        
        .stat-value.blue {
            color: var(--blue);
        }
        
        /* Distribution Section */
        .dist-section { 
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px; 
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .dist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .dist-title { 
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dist-bar { 
            display: flex; 
            height: 8px; 
            border-radius: 100px; 
            overflow: hidden; 
            background: var(--border);
        }
        
        .dist-zcashd { background: var(--accent); }
        .dist-zebra { background: var(--blue); }
        
        .dist-legend { 
            display: flex; 
            gap: 24px; 
            margin-top: 16px;
        }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .legend-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 3px;
        }
        
        .legend-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Nodes Section */
        .nodes-section { 
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px; 
            overflow: hidden;
        }
        
        .nodes-header { 
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; 
            align-items: center; 
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .nodes-title { 
            font-weight: 600;
            font-size: 15px;
        }
        
        .nodes-count {
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .search { 
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px; 
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 13px;
            width: 240px;
            margin-left: auto;
            transition: border-color 0.2s;
        }
        
        .search:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search::placeholder {
            color: var(--text-muted);
        }
        
        /* Table */
        table { 
            width: 100%; 
            border-collapse: collapse;
        }
        
        th { 
            padding: 12px 20px;
            text-align: left;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td { 
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td { 
            background: var(--bg-secondary);
        }
        
        .ip-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 12px;
        }
        
        .client-badge { 
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .badge-zcashd { 
            background: var(--accent-dim);
            color: var(--accent);
        }
        
        .badge-zebra { 
            background: var(--blue-dim);
            color: var(--blue);
        }
        
        .version-cell {
            color: var(--text-secondary);
        }
        
        .height-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 12px;
        }
        
        .time-cell {
            color: var(--text-muted);
        }
        
        /* Error Banner */
        .error { 
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            font-size: 13px;
        }
        
        /* Footer */
        footer { 
            text-align: center; 
            padding: 40px 24px;
            color: var(--text-muted);
            font-size: 13px;
        }
        
        footer a { 
            color: var(--accent);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Map Section */
        .map-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .map-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        #map {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 20px 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 1000;
            display: none;
        }
        
        .map-loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <nav>
        <div class="container nav-content">
            <img src="/zcash-logo.png" alt="Zcash" class="logo">
            <h1 class="brand">Z<span>Nodes</span></h1>
            <span class="live-badge">Live</span>
            <span class="uptime-chip">Uptime <span id="uptime">--</span></span>
        </div>
    </nav>
    
    <main>
        <div class="container">
            <div id="error" class="error">Connection failed. Retrying...</div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Reachable Nodes</div>
                    <div class="stat-value" id="total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Zcashd</div>
                    <div class="stat-value accent" id="zcashd">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Zebra</div>
                    <div class="stat-value blue" id="zebra">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Block Height</div>
                    <div class="stat-value" id="height">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Contacted</div>
                    <div class="stat-value" id="contacted">--</div>
                </div>
            </div>
            
            <div class="dist-section">
                <div class="dist-header">
                    <span class="dist-title">Client Distribution</span>
                </div>
                <div class="dist-bar" id="distBar"></div>
                <div class="dist-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background:var(--accent)"></div>
                        <span class="legend-value" id="zcashdPct">--%</span>
                        <span>Zcashd</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background:var(--blue)"></div>
                        <span class="legend-value" id="zebraPct">--%</span>
                        <span>Zebra</span>
                    </div>
                </div>
            </div>
            
            <div class="map-section">
                <div class="map-header">
                    <span class="map-title">Network Geography <span class="nodes-count">(<span id="mapNodeCount">0</span> nodes)</span></span>
                </div>
                <div id="map">
                    <div class="map-loading active" id="mapLoading">
                        <div style="color:var(--text-secondary);">Loading map...</div>
                    </div>
                </div>
            </div>
            
            <div class="nodes-section">
                <div class="nodes-header">
                    <span class="nodes-title">Network Nodes <span class="nodes-count">(<span id="nodeCount">0</span>)</span></span>
                    <input type="text" class="search" id="search" placeholder="Search IP or user agent..." oninput="renderNodes()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Port</th>
                            <th>Client</th>
                            <th>Version</th>
                            <th>Height</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <h2 style="font-size:16px;margin-bottom:12px;color:var(--text-secondary)">About ZNodes</h2>
            <p>ZNodes is a real-time Zcash network monitor that tracks all active zcashd and Zebra nodes on mainnet. Monitor network health, view node distribution, and explore the Zcash peer-to-peer network.</p>
            <p style="margin-top:12px">
                <a href="https://z.cash" target="_blank">Zcash Official</a> · 
                <a href="https://electriccoin.co" target="_blank">Electric Coin Co</a> · 
                <a href="https://zfnd.org" target="_blank">Zcash Foundation</a>
            </p>
            <p style="margin-top:16px;font-size:12px;color:var(--text-muted)">© 2025 ZNodes. Zcash node tracker and network explorer.</p>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let nodes = [];
        let stats = {};
        let map = null;
        let markers = [];
        
        // Load IP cache from localStorage
        const ipCache = new Map(JSON.parse(localStorage.getItem('ipGeoCache') || '[]'));
        
        // Save cache periodically
        setInterval(() => {
            localStorage.setItem('ipGeoCache', JSON.stringify([...ipCache]));
        }, 30000);

        // Initialize map
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        async function getGeoLocation(ip) {
            if (ipCache.has(ip)) {
                return ipCache.get(ip);
            }
            
            try {
                // Using ip-api.com - free, 45 req/min, no key needed
                const res = await fetch(`http://ip-api.com/json/${ip}?fields=status,message,country,city,lat,lon`);
                const data = await res.json();
                
                if (data.status === 'success' && data.lat && data.lon) {
                    const geo = {
                        lat: data.lat,
                        lon: data.lon,
                        city: data.city || 'Unknown',
                        country: data.country || 'Unknown'
                    };
                    ipCache.set(ip, geo);
                    return geo;
                }
            } catch (e) {
                console.error('Geo error for', ip, e);
            }
            return null;
        }

        async function updateMap() {
            if (!map) return;
            
            const loadingEl = document.getElementById('mapLoading');
            
            try {
                const res = await fetch('/rpc', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({jsonrpc: '2.0', id: 2, method: 'getgeonodes', params: []})
                });
                const data = await res.json();
                
                if (data.result && Array.isArray(data.result)) {
                    // Don't clear old markers, just update
                    const existingIps = new Set(markers.map(m => m.options.nodeIp));
                    
                    document.getElementById('mapNodeCount').textContent = data.result.length;
                    
                    // Only process new nodes to avoid hitting rate limits
                    const newNodes = data.result.filter(node => !existingIps.has(node.ip));
                    
                    if (newNodes.length > 0) {
                        console.log(`Adding ${newNodes.length} new nodes to map...`);
                        if (loadingEl) loadingEl.classList.add('active');
                        
                        // Batch process with slower rate
                        const batchSize = 3;
                        for (let i = 0; i < newNodes.length; i += batchSize) {
                            const batch = newNodes.slice(i, i + batchSize);
                            await Promise.all(batch.map(async node => {
                                const geo = await getGeoLocation(node.ip);
                                if (geo) {
                                    const color = node.client_type === 'zcashd' ? '#f4b728' : '#3b82f6';
                                    const marker = L.circleMarker([geo.lat, geo.lon], {
                                        radius: 6,
                                        fillColor: color,
                                        color: '#fff',
                                        weight: 1,
                                        opacity: 1,
                                        fillOpacity: 0.8,
                                        nodeIp: node.ip
                                    }).addTo(map);
                                    
                                    marker.bindPopup(`
                                        <div style="color:#000;font-size:12px;">
                                            <strong>${node.client_type}</strong><br>
                                            IP: ${node.ip}<br>
                                            Height: ${(node.height || 0).toLocaleString()}<br>
                                            Location: ${geo.city}, ${geo.country}
                                        </div>
                                    `);
                                    
                                    markers.push(marker);
                                }
                            }));
                            
                            // Wait between batches - slower to respect rate limits
                            if (i + batchSize < newNodes.length) {
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                        }
                        
                        if (loadingEl) loadingEl.classList.remove('active');
                    } else if (markers.length === 0 && data.result.length > 0) {
                        // First load - need to load all nodes
                        if (loadingEl) loadingEl.classList.add('active');
                        await updateMap(); // Recursive call will process them
                    } else {
                        // Hide loading if we have markers
                        if (loadingEl && markers.length > 0) loadingEl.classList.remove('active');
                    }
                }
            } catch (e) {
                console.error('Map update error:', e);
                if (loadingEl) loadingEl.classList.remove('active');
            }
        }
                    }
                }
            } catch (e) {
                console.error('Map update error:', e);
            }
        }

        async function fetchData() {
            try {
                const res = await fetch('/rpc', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({jsonrpc: '2.0', id: 0, method: 'getnodes', params: [false]})
                });
                const data = await res.json();
                
                if (data.result) {
                    nodes = data.result.nodes || [];
                    stats = data.result.stats || {};
                    updateUI();
                    document.getElementById('error').style.display = 'none';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('error').style.display = 'block';
            }
        }

        function formatRuntime(seconds) {
            const secs = Math.max(0, seconds || 0);
            if (secs === 0) return 'Starting';
            const days = Math.floor(secs / 86400);
            const hours = Math.floor((secs % 86400) / 3600);
            const minutes = Math.floor((secs % 3600) / 60);
            const remSecs = secs % 60;
            if (days > 0) {
                return `${days}d ${hours}h`;
            }
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            if (minutes > 0) {
                return `${minutes}m ${remSecs}s`;
            }
            return `${remSecs}s`;
        }

        function updateUI() {
            const zcashdNodes = nodes.filter(n => n.client_type === 'zcashd');
            const zebraNodes = nodes.filter(n => n.client_type === 'zebra');
            
            document.getElementById('total').textContent = nodes.length;
            document.getElementById('zcashd').textContent = zcashdNodes.length;
            document.getElementById('zebra').textContent = zebraNodes.length;
            document.getElementById('height').textContent = (stats.tip_height_estimate || 0).toLocaleString();
            document.getElementById('contacted').textContent = (stats.num_contacted_nodes || 0).toLocaleString();
            const uptimeEl = document.getElementById('uptime');
            if (uptimeEl) {
                uptimeEl.textContent = formatRuntime(stats.crawler_runtime_secs || 0);
            }
            
            
            // Distribution
            const total = nodes.length;
            if (total > 0) {
                const zPct = (zcashdNodes.length / total * 100).toFixed(1);
                const bPct = (zebraNodes.length / total * 100).toFixed(1);
                document.getElementById('distBar').innerHTML = `
                    <div class="dist-zcashd" style="width:${zPct}%"></div>
                    <div class="dist-zebra" style="width:${bPct}%"></div>
                `;
                document.getElementById('zcashdPct').textContent = zPct + '%';
                document.getElementById('zebraPct').textContent = bPct + '%';
            }
            
            renderNodes();
        }

        function renderNodes() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = nodes.filter(n => {
                const str = (n.ip + ' ' + (n.user_agent || '')).toLowerCase();
                return str.includes(search);
            });
            
            document.getElementById('nodeCount').textContent = filtered.length;
            
            const html = filtered.map(n => {
                const badge = n.client_type === 'zcashd' ? 'badge-zcashd' : 'badge-zebra';
                const version = (n.user_agent || '').replace(/\//g, '').replace('MagicBean:', '').replace('Zebra:', '');
                const lastSeen = n.last_seen_secs < 60 ? 'Just now' : 
                                n.last_seen_secs < 3600 ? Math.floor(n.last_seen_secs/60) + 'm ago' :
                                n.last_seen_secs < 86400 ? Math.floor(n.last_seen_secs/3600) + 'h ago' :
                                Math.floor(n.last_seen_secs/86400) + 'd ago';
                return `<tr>
                    <td class="ip-cell">${n.ip}</td>
                    <td>${n.port}</td>
                    <td><span class="client-badge ${badge}">${n.client_type}</span></td>
                    <td class="version-cell">${version}</td>
                    <td class="height-cell">${(n.height || 0).toLocaleString()}</td>
                    <td class="time-cell">${lastSeen}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('tbody').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px">No nodes found</td></tr>';
        }

        // Initial load and refresh every 10 seconds
        initMap();
        fetchData();
        setInterval(fetchData, 10000);
        
        // Update map every 5 minutes (less frequent due to rate limits)
        updateMap();
        setInterval(updateMap, 300000);
    </script>
</body>
</html>
